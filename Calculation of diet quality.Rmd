---
title: "R Notebook"
output: html_notebook
---

###SAS code
data fg2004.fi2004;
set chns_mas.nutr1_00;
if wave=2004;
run;

proc sql;
create table fct_type as
select *
from chns.fct a
left join pca.fct b
on a.FOODCODE=b.foodcode;
quit;


data fg2004.fr2004;
set chns_mas.nutr3_00;
if wave=2004;
run;

proc sql;
create table fr2004_fct as
select *
from fg2004.fr2004 a
left join fct_type b
on a.FOODCODE=b.foodcode;
quit;

proc sql;
create table fi2004_fct as
select *
from fg2004.fi2004 a
left join fct_type b
on a.FOODCODE=b.foodcode;
quit;

data fr2004_home;
set fr2004_fct;
if v43=1;
run;

data fr2004_home;
set fr2004_home;
if type=4 or type=5 or type=8 or type=9 or type=12;
run;

data fg2004.fr2004_home;
set fr2004_home;
run;

/**create table of indivdual intakes of veg and meat by day (for usual intakes)**/
proc sql;
create table fr2004_por_day as
select distinct IDInd, VD,hhid, sum(V39) as new_amt
from fr2004_home
group by IDInd,VD;
quit;

proc sql;
create table fr2004_por_total as
select distinct IDInd, sum(v39) as total_amt
from fr2004_home
group by IDInd;
quit;

proc sql;
create table fr2004_pro_day as
select *
from fr2004_por_day a
left join fr2004_por_total b
on a.IDInd=b.IDInd;
quit;

data fr2004_pro_day;
set fr2004_pro_day;
proportion=new_amt/total_amt;run;

/**create table of indivdual intakes of veg and meat all three days**/
proc sql;
create table fr2004_por_ind as
select distinct IDInd,hhid,sum(V39) as ind_amt
from fr2004_home
group by IDInd;
quit;

/**calculate household total intake**/
proc sql;
create table fr2004_por as
select distinct IDInd,hhid,sum(V39) as total_amt
from fr2004_home
group by hhid;
quit;

proc sql;
create table fg2004_pro as
select *
from fr2004_por a
left join fr2004_por_ind b
on a.idind=b.idind;
quit;

data fg2004_pro;
set fg2004_pro;
porportion=ind_amt/total_amt;
run;


/**calculate oil and condiments intakes from food inventory**/
data fi2004_oc;
set fi2004_fct;
if type=19 or type=20;
run;

proc sql;
create table fi2004_oc_sum as
select distinct hhid, foodcode,sum(V22) as total_fg_amt
from fi2004_oc
group by hhid,foodcode;
quit;

proc sql;
create table oc2004_ind as
select *
from fg2004_pro a
left join fi2004_oc_sum b
on a.hhid=b.hhid;
quit;

data fi2004_ocind;
set oc2004_ind;
amt=porportion*total_fg_amt;
drop ind_amt total_fg_amt total_amt porportion;
run;

data fg2004.fr2004_pro;
set fg2004_pro;
run;

data fg2004.fi2004_oc_sum;
set fi2004_oc_sum;
run;

data fg2004.fr2004_pro_day;
set fr2004_pro_day;
run;

data fg2004.fi2004_ocind;
set fi2004_ocind;
run;

data fr2004;
set fg2004.fr2004;
run;

/**create ID reference for oil and condiments intakes for each day**/
proc sql;
create table fr2004_day as
select distinct IDInd,VD,hhid
from fg2004.fr2004
group by IDInd,VD;
quit;

proc sql;
create table fr2004_day_pro as
select a.*,b.proportion
from fr2004_day a
left join fg2004.fr2004_pro_day b
on a.IDInd=b.IDInd and a.vd=b.vd;
quit;

data fr2004_day_pro;
set fr2004_day_pro;
if proportion= . then proportion=0;/**if proportion is missing, it means that the particular individual ate away from home at that particular day**/
run;

 
proc sql;
create table oc2004_day as
select *
from fr2004_day_pro a
left join fg2004.fi2004_ocind b
on a.idind=b.idind;
quit;

data oc2004_day;
set oc2004_day;
new_amt=proportion*amt;
if new_amt= . then new_amt=0;
drop amt proportion;
rename new_amt=amt;
run;

proc sql;
create table fr2004_d as
select distinct IDInd,VD,hhid,foodcode,sum(v39)as amt
from fg2004.fr2004
group by foodcode,vd,idind;
quit;

data fg2004_day;
set fr2004_d oc2004_day;
run;


/**calculate nutrients intakes of each food for each day**/
proc sql;
create table fg2004_day_nutr as
select *
from fg2004.fg2004_day a
left join fct_type b
on a.foodcode=b.foodcode;
quit;

data fg2004.fg2004_day_nutr;
set fg2004_day_nutr;
run;
/**some of the foodcodes are not available from the two fct books, subsequent analysis excluded those missing foodcode**/
data fg2004_day_nutr_nomissing;
set fg2004_day_nutr;
if foodcode>=1;
run;

data fg2004.fg2004_day_nutr_nomissing;
set fg2004_day_nutr_nomissing;
run;
######SAS code


首先需要手动输入钠含量，把盐摄入单独列出来。把脂肪酸含量数据加进去。

```{r import dataset}
library(tidyverse)
fatty2002 <- read.csv("data/fatty2002.csv",stringsAsFactors = F)
fatty2002 <- fatty2002 %>% dplyr::select(-FD_name)
fatty2002[is.na(fatty2002)] <- 0

fatty2004 <- read.csv("data/fatty2004.csv",stringsAsFactors = F)
fatty2004 <- fatty2004 %>% dplyr::select(-FD_name)
fatty2004[is.na(fatty2004)] <- 0

fct2002 <- read.csv("data/fct2002.csv",stringsAsFactors = F)
fct2002 <- fct2002 %>% dplyr::select(-FD_name)
fct2002 <- left_join(fct2002,fatty2002,by="Fcode")
fct2002[is.na(fct2002)] <- 0

fct2004 <- read.csv("data/fct2004.csv",stringsAsFactors = F)
fct2004 <- fct2004 %>% dplyr::select(-FD_name)
fct2004 <- left_join(fct2004,fatty2004,by="Fcode")
fct2004[is.na(fct2004)] <- 0

fct_all <- rbind(fct2002,fct2004)
fct_all <- dplyr::rename(fct_all,foodcode=Fcode)
write.csv(fct_all,"data/fct_all.csv",row.names = F)
```

```{r}

```

*CMFP index 计算方法*
在原有28个food group基础上重新计算各个component的得分：
1. Grain:谷物
2. Vegetable:fg10, fg11
3. Fruits:fg12, fg13
4. Dairy:fg21
5. Beans:大豆及其制品
6. Meat and Poutry:fg14-fg17
7. Fish and shrimp:fg19
8. Eggs:fg18
9. Fats and oils:27
10.Salt:fg28-需要重新计算

Dietary intakes were adjusted for total energy intake using density method and standardized to 2000 kcal. Intakes between minimum and maximum levels were scored proportionately.

*Dash 计算方法*
1. grain:6 serving, 28 gram
2. vegetables: 80g
3. fruit: 80g
4. dairy: 245g; 
5. meat, poultry and fish: 28g; 
6. eggs: 50g; 
7. nuts: 43g; 
8. seeds: 28g; 
9. legumes: 113g; 
10. fats and oils: 15g
11. Sweets,added sugars: sweets:15g,5/week
12. SSSB:5/week,SSSB:245g
13. sodium：

Serving size: vegetables and fruit: 80g; dairy: 245g; meat, poultry and fish: 28g; eggs: 50g; nuts: 43g; seeds: 28g; legumes: 113g; fats and oils: 15g.  

*AHEI*
1. Vegetable
2. Fruits
3. Nuts and legumes
4. Red/processed meat
5. Alcohol
6. SSB/Juice
7. EPA and DHA
8. PUFA
9. Sodium
10. Fibre

Serving size: vegetables and fruit: 80g; nuts and dry beans: 28g; legumes: 113g; meat: 113g. Potatoes did not count as vegetables. For alcohol components, nondrinkers received a score of 2.5. Since few women consumed alcohol in the SWHS, women who drank received a score of 5 and standards showing were for men.

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
